#!/usr/bin/env bash
# DocOps Lab pre-push hook template
# Managed by docopslab-dev gem
# Runs comprehensive linting before pushing to prevent issues in CI

set -e

echo "ğŸš€ DocOps Lab pre-push quality gate..."

# Check if we have any commits to push
LOCAL=$(git rev-parse @)
REMOTE=$(git rev-parse '@{u}' 2>/dev/null || echo "")
BASE=$(git merge-base @ '@{u}' 2>/dev/null || echo "")

if [[ -z "$REMOTE" ]]; then
  echo "â„¹ï¸  No remote tracking branch found, skipping pre-push checks."
  exit 0
fi

if [[ "$LOCAL" = "$REMOTE" ]]; then
  echo "â„¹ï¸  No new commits to push."
  exit 0
fi

if git diff --cached --name-only | grep -q 'Gemfile'; then
  if git diff --cached -U0 | grep -E '^\+.*gem [a-zA-Z0-9_-]+ .+ path:\s*['"'"'"].+['"'"'"]'; then
    echo ""
    echo "âš ï¸  Warning: Detected gems with local path: parameters in Gemfile changes."
    echo "ğŸ’¡ Consider using published gems from RubyGems.org or Git hosting services instead."
    echo ""
  fi
fi

echo "ğŸ“‹ Checking commits from $BASE to $LOCAL..."

# Run all linters on the codebase
echo "ğŸ” Running comprehensive linting..."

# Check config sync status first
if [[ -f ".config/docopslab-dev.yml" ]]; then
  echo "ğŸ”„ Verifying config sync..."
  if command -v bundle &> /dev/null; then
    if ! bundle exec rake labdev:config:sync --dry-run &> /dev/null; then
      echo "âŒ Config sync needed. Run: bundle exec rake labdev:config:sync"
      exit 1
    fi
    echo "âœ… Config sync verified"
  fi
fi

# Run all linters
if command -v bundle &> /dev/null; then
  echo "ğŸ§¹ Running all linters..."
  if ! bundle exec rake labdev:lint:all; then
    echo ""
    echo "âŒ Quality gate failed!"
    echo "ğŸ’¡ Suggested workflow:"
    echo "   1. Run: bundle exec rake labdev:heal"
    echo "   2. Review changes with: git diff"
    echo "   3. Commit auto-fixes: git commit -am 'Auto-fix linting issues'"
    echo "   4. Fix remaining issues manually"
    echo "   5. Try pushing again"
    echo ""
    echo "ğŸš« Or bypass with: git push --no-verify"
    exit 1
  fi
else
  echo "âš ï¸  Bundle not available, skipping linting checks"
fi

echo "âœ… Pre-push quality gate passed"
exit 0